# LCP项目完整测试用例说明文档

## 📋 测试概览

**配置KEY**: `lcpTestComplete`  
**配置名称**: LCP完整测试监控  
**API地址**: `http://localhost:8080/api/xmltest/complete_test_lcp_full`  
**项目类型**: 非GP项目 (procConditionGroup=01)

## 🎯 测试覆盖场景

### 1. 非GP项目XML数据处理
- **分隔符清理**: XML数据中的分隔符自动清理
- **索引重映射**: item_4,6,8,10... → item_4,5,6,7...

### 2. 下拉框联动测试
- **多个下拉框**: 加工系列 → 设备类型 → 设备型号 → 设备版本
- **单个下拉框**: 检测类型、物流模式
- **无下拉框**: 封装工序的所有字段

### 3. 数据源混合测试
- **API数据源**: 从清理后的XML获取数据
- **数据库数据源**: 从LCP生产数据表获取
- **计算字段**: 温度和速度的乘积运算

---

## 📊 详细测试用例

### 🔤 **表单区域测试**

#### 测试步骤
1. 在"LCP品名"输入框输入：`LCP-TEST-001`
2. 按回车键，观察下拉框选项加载（验证分隔符清理）
3. 依次选择各下拉框选项
4. 再次按回车键触发数据查询

#### 期望结果

| 下拉框 | 配置表达式 | XML原始位置 | 清理后位置 | 预期选项 | 验证点 |
|--------|-----------|------------|-----------|----------|--------|
| 加工系列 | 001;2;2 | item_2 | item_2 | 加工系列X, 加工系列Y, 加工系列Z | 第2位置，无需清理 |
| 设备类型 | 001;2;5 | item_5 | item_4 | X型设备, Y型设备, Z型设备 | 分隔符清理：5→4 |
| 设备型号 | 001;2;7 | item_7 | item_5 | X1型号, X2型号, Y1型号, Z1型号 | 分隔符清理：7→5 |
| 设备版本 | 001;2;9 | item_9 | item_6 | Ver1.0, Ver1.5, Ver2.0, Ver3.0 | 分隔符清理：9→6 |
| 检测类型 | 002;2;2 | item_2 | item_2 | 检测类型A, 检测类型B, 检测类型Z | cd=002数据 |
| 物流模式 | 004;2;2 | item_2 | item_2 | 物流模式A, 物流模式B | cd=004数据 |

#### XML数据清理验证
**原始XML结构** (cd=001):
```
item_0: 01 (procConditionGroup)
item_1: LCP-TEST-001 (LCP品名)
item_2: 加工系列X (保持不变)
item_3: 001 (cd)
item_4: 分隔符1 (被清理)
item_5: X型设备 (移动到item_4)
item_6: 分隔符2 (被清理)
item_7: X1型号 (移动到item_5)
...
```

**清理后结构**:
```
item_0: 01
item_1: LCP-TEST-001
item_2: 加工系列X
item_3: 001
item_4: X型设备 ✓ (原item_5)
item_5: X1型号 ✓ (原item_7)
item_6: Ver1.0 ✓ (原item_9)
...
```

---

### 📝 **基础信息区域测试**

| 字段名 | 数据源 | 配置表达式 | XML位置 | 预期值 | 验证点 |
|-------|--------|-----------|---------|--------|--------|
| LCP品名(API) | API | 001;3;1 | item_1 | LCP-TEST-001 | API直接获取 |
| 加工系列(API) | API | 001;3;2 | item_2 | 加工系列X | API直接获取 |
| 设备类型(API) | API | 001;3;4 | item_4(原5) | X型设备 | **分隔符清理验证** |
| 加工温度(API) | API | 001;3;7 | item_7(原11) | 85.5 | **分隔符清理验证** |
| 加工速度(API) | API | 001;3;8 | item_8(原13) | 12.5 | **分隔符清理验证** |
| 温度速度乘积(API-计算) | API | processingTemp * processingSpeed | 计算 | 1068.75 | 计算：85.5*12.5 |
| 作业员1(DB) | 数据库 | SELECT operator1... | DB | 孙七 | 数据库查询 |
| 班次1(DB) | 数据库 | SELECT shift1... | DB | 白班 | 数据库查询 |
| 生产日期1(DB) | 数据库 | SELECT product_date1... | DB | 2025-01-15 | 数据库查询 |
| 检测温度(cd=002) | API | 002;3;7 | item_7(cd=002) | 156.8 | 不同cd验证 |

---

### 💬 **备注区域测试**

| 备注标题 | 数据源 | 预期内容 |
|---------|--------|----------|
| 生产备注1(DB) | 数据库 | LCP-TEST-001测试数据，覆盖非GP项目的完整测试场景... |
| 生产备注2(DB) | 数据库 | LCP测试项目运行稳定，非GP项目的分隔符清理功能正常工作... |

---

### 📋 **表格区域测试**

#### 表格1: 印刷检查、面积检查

| 行类型 | 项目名 | 子项名 | 单位 | 数据源 | 预期值 | 验证点 |
|-------|--------|--------|------|--------|--------|--------|
| 简单行 | LCP处置项次 | - | - | 数据库 | LCP处置项次001 | 简单行无单位 |
| 简单行 | 三温炉时间 | - | - | 数据库 | 110秒 | 简单行无单位 |
| 简单行 | 速度 | - | m/min | 数据库 | 12.5 | 简单行有单位 |
| 简单行 | 炉温（开/关/开） | - | - | 数据库 | 220℃/关/220℃ | 简单行无单位 |
| 简单行 | LCP量 | - | um | 数据库 | 15.8 | 简单行有单位 |
| 复杂行 | 基准精度/尺度 | L | um | 数据库 | 8.5 | 复杂行主项目 |
| 复杂行 | - | W | um | 数据库 | 5.3 | 复杂行子项目 |

#### 表格2: 温度检查

| 行类型 | 项目名 | 单位 | 数据源 | 预期值 |
|-------|--------|------|--------|--------|
| 简单行 | 预热温度 | - | 数据库 | 60℃ |
| 简单行 | 加热温度 | - | 数据库 | 220℃ |
| 简单行 | 冷却温度 | - | 数据库 | 15℃ |

#### 表格3: API数据验证

| 行类型 | 项目名 | 子项名 | 单位 | 数据源 | 原XML位置 | 清理后 | 预期值 | 验证点 |
|-------|--------|--------|------|--------|----------|--------|--------|--------|
| 简单行 | API温度(cd=001) | - | ℃ | API | item_11 | item_7 | 85.5 | **分隔符清理** |
| 简单行 | API检测时间(cd=002) | - | min | API | item_13 | item_8 | 25.5 | **不同cd+清理** |
| 复杂行 | 混合数据源 | API原料 | - | API | item_15 | item_9 | LCP原料A | **分隔符清理** |
| 复杂行 | - | DB计算 | - | 数据库 | - | - | 6.25 | 计算：12.5/2 |

---

## 🔍 **非GP项目特殊测试**

### 1. 分隔符清理算法验证

**测试数据**: cd=001的XML行
```xml
<row>
  <item>01</item>           <!-- item_0 -->
  <item>LCP-TEST-001</item> <!-- item_1 -->  
  <item>加工系列X</item>      <!-- item_2 -->
  <item>001</item>          <!-- item_3 -->
  <item>分隔符1</item>       <!-- item_4: 分隔符，应被清理 -->
  <item>X型设备</item>       <!-- item_5: 移动到item_4 -->
  <item>分隔符2</item>       <!-- item_6: 分隔符，应被清理 -->
  <item>X1型号</item>        <!-- item_7: 移动到item_5 -->
  ...
</row>
```

**清理规则**:
- item_0 到 item_3: 保持不变
- item_4开始: 偶数位置(4,6,8,10...)为分隔符，清理
- 奇数位置(5,7,9,11...)为有效数据，向前移动

**验证点**:
- `001;3;4` 应该取到 "X型设备" (原item_5)
- `001;3;5` 应该取到 "X1型号" (原item_7) 
- `001;3;6` 应该取到 "Ver1.0" (原item_9)

### 2. 品名隔离测试
**输入**: `LCP-TEST-002`
**预期**: 显示加工系列Z、检测类型Z等专属选项

### 3. 多cd数据混合测试
**输入**: `LCP-TEST-001`，包含cd=001,002,003,004
**验证**: 
- cd=001: 基础加工数据，多下拉框
- cd=002: 检测数据，单下拉框
- cd=003: 封装数据，无下拉框
- cd=004: 物流数据，部分下拉框

---

## ⚠️ **常见问题排查**

### 问题1: 分隔符清理失效
- **检查**: MonitorDataProcessor.cleanXmlRowIfNeeded()方法
- **验证**: 非GP项目(procConditionGroup=01)应触发清理
- **期望**: item_4,6,8...被移除，5,7,9...向前移动

### 问题2: 下拉框选项错误
- **检查**: 表达式中的位置是否考虑了分隔符清理
- **验证**: `001;2;5`在清理后应该取item_4位置的数据
- **期望**: 配置表达式与清理后的实际位置对应

### 问题3: API数据取值异常
- **检查**: API表达式是否使用清理后的位置
- **验证**: `001;3;7`应该取清理后item_7的数据
- **期望**: 数据源一致性

### 问题4: 计算字段错误
- **检查**: 参与计算的变量是否正确提取
- **验证**: processingTemp和processingSpeed是否都有值
- **期望**: 85.5 * 12.5 = 1068.75

### 问题5: 不同cd数据混乱
- **检查**: cd索引位置配置
- **验证**: GP项目cd在item_5，非GP项目cd在item_3
- **期望**: 根据procConditionGroup正确使用cd位置

---

## 🧪 **分隔符清理算法测试**

### 输入数据
```
原始: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]
含义: [01,品名,系列,cd,分隔符1,设备类型,分隔符2,设备型号,分隔符3,设备版本,分隔符4,加工温度,分隔符5,加工速度,分隔符6,原料类型,分隔符7,额外数据]
```

### 清理后数据
```
结果: [0,1,2,3,4,5,6,7,8,9,10]
含义: [01,品名,系列,cd,设备类型,设备型号,设备版本,加工温度,加工速度,原料类型,额外数据]
```

### 表达式映射
| 配置表达式 | 原始位置 | 清理后位置 | 实际数据 |
|-----------|----------|-----------|----------|
| 001;2;2 | item_2 | item_2 | 加工系列X |
| 001;2;5 | item_5 | item_4 | X型设备 |
| 001;2;7 | item_7 | item_5 | X1型号 |
| 001;2;9 | item_9 | item_6 | Ver1.0 |
| 001;3;7 | item_11 | item_7 | 85.5 |
| 001;3;8 | item_13 | item_8 | 12.5 |
| 001;3;9 | item_15 | item_9 | LCP原料A |

---

## ✅ **测试检查清单**

### 基础功能
- [ ] XML分隔符清理功能正常
- [ ] 下拉框选项正确加载（考虑清理后位置）
- [ ] 下拉框联动功能正常
- [ ] API数据源正确获取（清理后数据）
- [ ] 数据库数据源正常查询
- [ ] 计算字段结果正确

### LCP特有功能
- [ ] procConditionGroup=01正确识别
- [ ] 非GP项目cd位置正确(item_3)
- [ ] 分隔符清理算法正确执行
- [ ] 清理后的数据索引正确映射
- [ ] 多cd数据正确隔离和处理

### 表格功能
- [ ] 简单行表格显示正确
- [ ] 复杂行表格显示正确
- [ ] 混合数据源表格正常工作
- [ ] 清理后API数据在表格中正确显示

### 系统功能
- [ ] 品名隔离功能正常
- [ ] 缓存机制正常工作
- [ ] 错误处理正常
- [ ] 性能满足要求

## 🎯 **测试完成标准**

1. **分隔符清理准确率**: 100%
2. **数据索引映射正确率**: 100%  
3. **功能完整性**: 100%
4. **与GP项目的区别正确处理**: 100%
5. **用户体验良好，无明显延迟**

## 📚 **技术要点总结**

1. **非GP项目核心区别**: 
   - XML数据包含分隔符需要清理
   - cd位置在item_3而非item_5
   - 配置表达式需要考虑清理后的实际位置

2. **关键算法**:
   - `MonitorDataProcessor.cleanXmlRowIfNeeded()`
   - 偶数位置(>=4)分隔符移除
   - 奇数位置数据前移

3. **测试重点**:
   - 表达式位置映射正确性
   - 清理前后数据一致性
   - 多cd场景的正确处理
